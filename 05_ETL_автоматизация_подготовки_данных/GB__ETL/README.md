# GB__ETL
ETL: автоматизация подготовки данных

## Урок 1. Модели данных и нормализация таблиц. Схема «звезда»
### Домашнее задание вариант 1
1. Нарисуйте архитектуру ETL процесса для сбора и анализа данных компанией которая хочет провести маркетинговую кампанию, используя app.diagrams.net. Сделайте описание почему вы считаете что архитектура должна выглядеть именно так.
2. Постройте реляционную и иерархическую модели данных для магазина который продает телефоны.
3. Определите в какой нормальной форме данная таблица, приведите её ко 2 и 3 нормальным формам последовательно.

### Домашнее задание вариант 2
3. Определите в какой нормальной форме данная таблица, приведите ее ко 2 и 3 нормальным формам последовательно.  
Нужно в apache spark создать таблицу с данными ниже. Можно импортировать из Excel либо сгенерировать ее кодом.  
Сделать нормализацию по образцу (например, как здесь https://ru.wikipedia.org/wiki/%D0%92%D1%82%D0%BE%D1%80%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0 ).  
Сохранить полученный результат в БД. На проверку соберите код, скриншоты отработки консоли спарка и полученный результат в БД в один pdf файл.  
Employee_ID | Name 	| Job_Code 	| Job 		| City_code | Home_city  
E001 		| Alice | J01 		| Chef 		| 26 		| Moscow  
E001 		| Alice | J02 		| Waiter 	| 26 		| Moscow  
E002 		| Bob 	| J02 		| Waiter 	| 56 		| Perm  
E002 		| Bob 	| J03 		| Bartender | 56 		| Perm  
E003 		| Alice | J01 		| Chef 		| 56 		| Perm  

## Урок 2. Введение в подготовку данных для аналитиков. Таблицы фактов и таблицы измерений
1. Скачайте датасет fifаs2.сsv. Проанализируйте его и определите, какие данные являются неполными. Удалите ненужные колонки и недостающие значения.
2. Найдите в датафрейме полные дубликаты и удалите их. Значения могут быть одинаковыми, но написаны по-разному. Например, может отличаться размер регистра (заглавные и строчные буквы). Особое внимание уделить колонке с названиями команд.
3. Напишите функцию, которая добавит колонку с разбиением возраста по группам: до 20, от 20 до 30, от 30 до 36 и старше 36. Посчитайте количество футболистов в каждой категории.

## Урок 3. Получение денормализованных таблиц из нормализованных
### Домашнее задание вариант 1
1. Денормализуйте таблицу так, чтобы не нужно было для каждого рекламодателя постоянно подсчитывать количество кампаний и продаж.
2. В базе данных есть две таблицы: страны и клиенты. Одной из потребностей компании является исследование клиентов и стран с точки зрения эффективности продаж, поэтому часто выполняются объединения между таблицами: клиенты и страны. Что нужно сделать, чтобы ограничить частое объединение этих двух таблиц?
3. Вернемся к первому примеру. Предположим, компания хочет регулярно извлекать данные о продажах, например, о кампаниях или рекламодателях с полными именами. Как мы можем решить проблему постоянной необходимости объединения таблиц?

### Домашнее задание вариант 2 (реализовано данное решение)
Из задания которое разбирали на семинаре взять запрос и использовать его в скаловском скрипте, через спарк создать вторую таблицу. И сделать через GROUP_CONCAT список как на семинаре, Сделайте формат времени 11.01.23 22.29 (без секунд) и через case сократите названия статусов (Например, Зарегистрирован ->З, Закрыт -> ЗТ).

### Домашнее задание вариант 3
Всю туже самую логику запроса перенести на спарк. (основную задачу0 которую разбирали на семинаре, если хотите можете также через спарк сделать и вариант 1, найти аналог group_concat в спарке).

## Урок 4. Партицирование данных по дате. Динамическое партицирование
### Домашнее задание вариант 1
1. Создайте таблицу movies с полями movies_type, director, year_of_issue, length_in_minutes, rate.
2. Сделайте таблицы для горизонтального партицирования по году выпуска (до 1990, 1990 -2000, 2000- 2010, 2010-2020, после 2020).
3. Сделайте таблицы для горизонтального партицирования по длине фильма (до 40 минута, от 40 до 90 минут, от 90 до 130 минут, более 130 минут).
4. Сделайте таблицы для горизонтального партицирования по рейтингу фильма (ниже 5, от 5 до 8, от 8до 10).
5. Создайте правила добавления данных для каждой таблицы.
6. Добавьте фильмы так, чтобы в каждой таблице было не менее 3 фильмов.
7. Добавьте пару фильмов с рейтингом выше 10.
8. Сделайте выбор из всех таблиц, в том числе из основной.
9. Сделайте выбор только из основной таблицы.

### Домашнее задание вариант 2
1. За основу возьмите Задание 4 решенное на семинаре.
2. В файле s4_2 параметры кредита: Займ 9400000, срок 30 лет, ставка 10.6%.
3. Через https://calcus.ru/kreditnyj-kalkulyator-s-dosrochnym-pogasheniem добавьте два листа в Excel с постоянным платежом 120 или 150 тыс. руб. (Необязательно, но можете также сделать и для платежа 250 и 300).
4. Добавьте графики с досрочным погашением по этим пирометрам. Т.е. линии по выплатам основного долга и процентов если платеж будет 120 или 150 тыс. руб. В результате должно получиться 6 линий.
5. Используйте разные цвета.

## Урок 5. Обзор возможностей Airflow, установка и настройка
### Домашнее задание вариант 1
1. Скачайте файл my_first_dag.py, поместите его в папку airflow/dags. Перезапустите airflow и запустите этот dag.
2. Посмотрите логи вывода.
3. Измените этот dag так, чтобы он выводил в консоль текст «Привет + ваше имя». Посмотрите в логах, что dag выводит
то, что вы хотите.
4. Скачайте файл my_second_dag.py поместите его в папку airflow/dags.
5. Объясните, что происходит в рамках этого процесса.

### Домашнее задание вариант 2
Установите аирфлоу как показано на семинаре, соберите список команд установки, скриншоты GUI и работы аирфлоу из мобы. Соберите все данные в один pdf файл. Проверить гипотезу будет ли достаточно установки sudo apt install -y python3 python3-pip python3-venv без sudo apt install python3.8. Создайте мануал со списком команд для установки.

## Урок 6. Операторы в Airflow и их применение для ETL
### Домашнее задание вариант 1
1. Создайте новый граф. Добавьте в него BashOperator, который будет генерировать рандомное число и печатать его в
консоль.
2. Создайте PythonOperator, который генерирует рандомное число, возводит его в квадрат и выводит в консоль исходное число и результат.
3. Сделайте оператор, который отправляет запрос к https://goweather.herokuapp.com/weather/"location" (вместо location используйте ваше местоположение).
4. Задайте последовательный порядок выполнения операторов.

### Домашнее задание вариант 2
1. Установить спарк как показано на семинаре, используя следующие команды.  
2. nano ~/.bashrc  
3. export SPARK_HOME=/home/spark && export PATH=$PATH:$SPARK_HOME/bin:$SPARK_HOME/sbin  
4. source ~/.bashrc  
5. sudo apt-get install openjdk-8-jdk  
6. pip install pyspark==3.2.4  
7. pip install pandas==1.5.3  
8. pip install SQLAlchemy==1.4.46  
9. Используйте ДЗ которые вы мне высылали для 3-4 семинара. Запустите данные задачи ПОСЛЕДОВАТЕЛЬНО, одну за другой в аирфлоу. Пришлите мне скриншоты выполненных задач в аирфлоу, логов аирфлоу, скриншоты что у вас записались таблицы в БД mysql на WSL. По возможности доработайте код чтобы изображение с линии платежей генерировалось в указанную директорию. Скриншоты соберите в pdf.  

## Урок 7. Построение пайплайнов и визуализация потоков данных в Airflow
### Домашнее задание вариант 1
1. Зарегистрируйтесь в ОрепWeatherApi (https://openweathermap.org/api)
2. Создайте ETL, который получает температуру в заданной вами локации, и дальше делает ветвление:  
— В случае, если температура больше 15 градусов цельсия — идёт на ветку, в которой есть оператор, выводящий на экран «тепло»;  
— В случае, если температура ниже 15 градусов, идёт на ветку с оператором, который выводит в консоль «холодно».  
3. Оператор ветвления должен выводить в консоль полученную от АРI температуру.  
4. Приложите скриншот графа и логов работы оператора ветвленния.  

### Домашнее задание вариант 2
1. Научитесь запускать после перезапуска WSL.
2. Понять отличия между bash и python оператором.
3. Взять за основу dag с 6-го семинара и через pythonoprtator используя pandas сделать по аналогии задание из 4-го семинара.
4. Округлить значения по накопленному итогу процентов и выплат по основному долгу.
5. Записать в одну таблицу три случая по выплатам. 360 месяцев без досрочного погашения, и с выплатами 120 и 150 тыс. рублей. Обработку сделать в пандасе. 

## Урок 8. Специфика применения ETL в различных предметных сферах
### Домашнее задание вариант 1
1. Скачайте файлы boking.csv, client.csv и hotel.csv.
2. Создайте новый dag.
3. Создайте три оператора для получения данных и загрузите файлы. 
4. Передайте дата фреймы в оператор трансформации.
5. Создайте оператор который будет трансформировать данные:
— Объедините все таблицы в одну;  
— Приведите даты к одному виду;  
— Удалите невалидные колонки;  
— Приведите все валюты к одной.  
6. Создайте оператор загрузки в базу данных.
7. Запустите dag.

### Домашнее задание вариант 2
1. Доработать задачу python_wather с тем чтобы полученные значения погоды писать в таблицу mysql. 
2. Погоду яндекс и OW записываем в отдельные столбцы. 
3. Добавить в тритий столбец метку текущего времени.
4. Попробовать запусть телеграмм бот. В случае успеха дать подробное описание, что сделали/изменили, как настроили бот.